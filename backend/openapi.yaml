openapi: 3.0.0
info:
  title: Filter iCal
  version: 1.0.0
  description: Contract-first API for iCal calendar management with domain support
  servers:
    - url: http://localhost:3000
      description: Development server

paths:
  # Regular calendar management (user-added calendars)
  /calendars:
    post:
      summary: Add a user calendar
      parameters:
        - name: username
          in: query
          schema:
            type: string
          description: Optional username to associate the calendar with
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, source_url]
              properties:
                name:
                  type: string
                  example: "My Work Calendar"
                source_url:
                  type: string
                  format: uri
                  example: "https://example.com/calendar.ics"
      responses:
        '201':
          description: Calendar created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Calendar'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    
    get:
      summary: List user calendars
      parameters:
        - name: username
          in: query
          schema:
            type: string
          description: Optional username to filter by
      responses:
        '200':
          description: List of calendars
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Calendar'

  /calendars/{calendarId}:
    delete:
      summary: Delete a user calendar
      parameters:
        - name: calendarId
          in: path
          required: true
          schema:
            type: integer
        - name: username
          in: query
          schema:
            type: string
      responses:
        '204':
          description: Calendar deleted
        '404':
          description: Calendar not found

  /calendars/{calendarId}/events:
    get:
      summary: Get calendar events (flat structure for user calendars)
      parameters:
        - name: calendarId
          in: path
          required: true
          schema:
            type: integer
        - name: username
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Calendar events
          content:
            application/json:
              schema:
                type: object
                properties:
                  events:
                    type: array
                    items:
                      $ref: '#/components/schemas/Event'
        '404':
          description: Calendar not found

  /calendars/{calendarId}/filters:
    post:
      summary: Create filter for user calendar
      parameters:
        - name: calendarId
          in: path
          required: true
          schema:
            type: integer
        - name: username
          in: query
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  example: "Work meetings only"
                subscribed_event_ids:
                  type: array
                  items:
                    type: integer
                  example: [1, 2, 5]
                include_future_events:
                  type: boolean
                  default: false
                  description: "Automatically include new recurring events added after filter creation"
      responses:
        '201':
          description: Filter created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Filter'
        '400':
          description: Invalid input
        '404':
          description: Calendar not found
    
    get:
      summary: List filters for user calendar
      parameters:
        - name: calendarId
          in: path
          required: true
          schema:
            type: integer
        - name: username
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of filters
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Filter'
        '404':
          description: Calendar not found

  /calendars/{calendarId}/filters/{filterId}:
    delete:
      summary: Delete filter for user calendar
      parameters:
        - name: calendarId
          in: path
          required: true
          schema:
            type: integer
        - name: filterId
          in: path
          required: true
          schema:
            type: integer
        - name: username
          in: query
          schema:
            type: string
      responses:
        '204':
          description: Filter deleted
        '404':
          description: Filter or calendar not found

  # Domain-specific endpoints (auto-created from domains.yaml)
  /domains/{domain}/events:
    get:
      summary: Get domain calendar events (grouped structure)
      parameters:
        - name: domain
          in: path
          required: true
          schema:
            type: string
          example: "exter"
        - name: username
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Domain events with groups
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DomainEventsResponse'
        '404':
          description: Domain not found

  /domains/{domain}/groups:
    get:
      summary: Get groups for domain calendar
      parameters:
        - name: domain
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: List of groups
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Group'
        '404':
          description: Domain not found
    
    post:
      summary: Create a new group (admin)
      parameters:
        - name: domain
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  example: "BCC Events"
      responses:
        '201':
          description: Group created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Group'
        '400':
          description: Invalid input
        '404':
          description: Domain not found

  /domains/{domain}/groups/{groupId}/assign-recurring-events:
    put:
      summary: Manually assign recurring events to group (admin)
      parameters:
        - name: domain
          in: path
          required: true
          schema:
            type: string
        - name: groupId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                recurring_event_titles:
                  type: array
                  items:
                    type: string
                  example: ["Weekly Team Meeting", "Monthly Review"]
      responses:
        '200':
          description: Recurring events assigned successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "2 recurring events assigned to group"
        '404':
          description: Domain or group not found

  /domains/{domain}/groups/{groupId}/remove-events:
    put:
      summary: Remove events from specific group (admin)
      description: Remove recurring events from a specific group while preserving assignments to other groups
      parameters:
        - name: domain
          in: path
          required: true
          schema:
            type: string
        - name: groupId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [recurring_event_titles]
              properties:
                recurring_event_titles:
                  type: array
                  items:
                    type: string
                  example: ["Weekly Team Meeting", "Monthly Review"]
      responses:
        '200':
          description: Events successfully removed from group
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "2 events removed from group"
                  removed_count:
                    type: integer
                    example: 2
        '400':
          description: Invalid input
        '404':
          description: Domain or group not found

  /domains/{domain}/assignment-rules:
    post:
      summary: Create auto-assignment rule (admin)
      parameters:
        - name: domain
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [rule_type, rule_value, target_group_id]
              properties:
                rule_type:
                  type: string
                  enum: [title_contains, description_contains]
                  example: "title_contains"
                rule_value:
                  type: string
                  example: "Event"
                target_group_id:
                  type: integer
                  example: 1
      responses:
        '201':
          description: Rule created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssignmentRule'
        '400':
          description: Invalid input
        '404':
          description: Domain not found

    get:
      summary: List assignment rules for domain
      parameters:
        - name: domain
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: List of assignment rules
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AssignmentRule'

  /domains/{domain}/filters:
    post:
      summary: Create filter for domain calendar
      parameters:
        - name: domain
          in: path
          required: true
          schema:
            type: string
        - name: username
          in: query
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  example: "BCC Events + Selected Meetings"
                subscribed_event_ids:
                  type: array
                  items:
                    type: integer
                  example: [1, 2, 5]
                subscribed_group_ids:
                  type: array
                  items:
                    type: integer
                  example: [1, 3]
      responses:
        '201':
          description: Filter created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Filter'
        '400':
          description: Invalid input
        '404':
          description: Domain not found
    
    get:
      summary: List filters for domain calendar
      parameters:
        - name: domain
          in: path
          required: true
          schema:
            type: string
        - name: username
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of filters
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Filter'
        '404':
          description: Domain not found

  /domains/{domain}/filters/{filterId}:
    delete:
      summary: Delete filter for domain calendar
      parameters:
        - name: domain
          in: path
          required: true
          schema:
            type: string
        - name: filterId
          in: path
          required: true
          schema:
            type: integer
        - name: username
          in: query
          schema:
            type: string
      responses:
        '204':
          description: Filter deleted
        '404':
          description: Filter or domain not found

  # Domain Configuration Backups
  /domains/{domain}/backups:
    post:
      summary: Create a backup of current domain configuration
      description: Creates a snapshot of all groups, assignments, and rules for the domain
      parameters:
        - name: domain
          in: path
          required: true
          schema:
            type: string
          example: "exter"
        - name: description
          in: query
          schema:
            type: string
          description: Optional description for the backup
          example: "Before major restructuring"
      responses:
        '201':
          description: Backup created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DomainBackup'
        '404':
          description: Domain not found
        '500':
          description: Backup creation failed

    get:
      summary: List all backups for a domain
      description: Returns all configuration snapshots ordered by creation date (newest first)
      parameters:
        - name: domain
          in: path
          required: true
          schema:
            type: string
          example: "exter"
      responses:
        '200':
          description: List of backups
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DomainBackup'
        '404':
          description: Domain not found

  /domains/{domain}/backups/{backupId}:
    delete:
      summary: Delete a backup
      description: Permanently deletes a backup snapshot
      parameters:
        - name: domain
          in: path
          required: true
          schema:
            type: string
          example: "exter"
        - name: backupId
          in: path
          required: true
          schema:
            type: integer
          example: 42
      responses:
        '200':
          description: Backup deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Backup deleted successfully"
        '404':
          description: Backup or domain not found

  /domains/{domain}/backups/{backupId}/restore:
    post:
      summary: Restore domain from a backup
      description: Restores all groups, assignments, and rules from a backup snapshot. Current configuration is automatically backed up first.
      parameters:
        - name: domain
          in: path
          required: true
          schema:
            type: string
          example: "exter"
        - name: backupId
          in: path
          required: true
          schema:
            type: integer
          example: 42
      responses:
        '200':
          description: Configuration restored successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Domain restored from backup"
                  auto_backup_id:
                    type: integer
                    description: ID of the auto-created backup before restore
                    example: 43
        '404':
          description: Backup or domain not found
        '500':
          description: Restore failed

  /domains/{domain}/backups/{backupId}/download:
    get:
      summary: Download a backup as YAML file
      description: Downloads the backup configuration as a YAML file
      parameters:
        - name: domain
          in: path
          required: true
          schema:
            type: string
          example: "exter"
        - name: backupId
          in: path
          required: true
          schema:
            type: integer
          example: 42
      responses:
        '200':
          description: YAML configuration file
          content:
            application/x-yaml:
              schema:
                type: string
                example: |
                  domain: exter
                  calendars:
                    - name: "Exter Event Calendar"
                      url: "https://example.com/calendar.ics"
                  groups:
                    - id: "fussball"
                      name: "âš½ FuÃŸball"
                      description: "Football activities"
        '404':
          description: Backup or domain not found

  # Dynamic iCal Export
  /ical/{uuid}.ics:
    get:
      summary: Export filtered calendar as iCal file
      parameters:
        - name: uuid
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Filtered iCal file
          content:
            text/calendar:
              schema:
                type: string
                example: |
                  BEGIN:VCALENDAR
                  VERSION:2.0
                  PRODID:-//iCal Viewer//EN
                  BEGIN:VEVENT
                  UID:example@icalviewer.com
                  DTSTART:20241201T100000Z
                  DTEND:20241201T110000Z
                  SUMMARY:Team Meeting
                  END:VEVENT
                  END:VCALENDAR
        '404':
          description: Filter not found

components:
  schemas:
    Calendar:
      type: object
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: "My Work Calendar"
        source_url:
          type: string
          format: uri
          example: "https://example.com/calendar.ics"
        type:
          type: string
          enum: [user, domain]
          example: "user"
        domain_key:
          type: string
          description: "Only present for domain calendars"
          example: "exter"
        username:
          type: string
          example: "john_doe"
        last_fetched:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"

    DomainBackup:
      type: object
      properties:
        id:
          type: integer
          example: 42
          description: "Unique backup ID"
        domain_key:
          type: string
          example: "exter"
          description: "Domain this backup belongs to"
        config_snapshot:
          type: object
          description: "Full domain configuration snapshot in YAML-compatible format"
          example:
            domain: "exter"
            groups:
              - id: "fussball"
                name: "âš½ FuÃŸball"
                description: "Football activities"
            assignments:
              fussball:
                - "Football Training"
                - "Match Day"
        created_at:
          type: string
          format: date-time
          example: "2025-01-10T14:23:15Z"
          description: "When the backup was created"
        created_by:
          type: string
          example: "admin"
          description: "User who created the backup (optional)"
          nullable: true
        description:
          type: string
          example: "Before major restructuring"
          description: "Optional backup description"
          nullable: true
        backup_type:
          type: string
          enum: [manual, auto_pre_reset, auto_pre_import, auto_pre_restore]
          example: "manual"
          description: "Type of backup: manual (user-initiated) or automatic"

    DomainEventsResponse:
      type: object
      properties:
        groups:
          type: array
          items:
            $ref: '#/components/schemas/GroupWithEvents'
          description: "All events organized into groups. Ungrouped events are automatically assigned to 'Other Recurring Events' or 'Special Events' groups."
        ungrouped_events:
          type: array
          items:
            $ref: '#/components/schemas/RecurringEvent'
          description: "Events that are not assigned to any specific group."

    GroupWithEvents:
      type: object
      properties:
        id:
          type: integer
          example: 1
          description: "Group ID. Auto-created groups use string IDs like 'exter_auto_recurring'"
        name:
          type: string
          example: "BCC Events"
          description: "Group name. Auto-created groups use names like 'ðŸ“… Other Recurring Events' or 'ðŸŽ¯ Special Events'"
        recurring_events:
          type: array
          items:
            $ref: '#/components/schemas/RecurringEvent'
          description: "All events in this group, including both manually assigned and auto-assigned events"

    RecurringEvent:
      type: object
      properties:
        title:
          type: string
          example: "Weekly Team Meeting"
        event_count:
          type: integer
          example: 4
          description: "Number of individual events with this title"
        events:
          type: array
          items:
            $ref: '#/components/schemas/Event'

    Event:
      type: object
      properties:
        id:
          type: integer
          example: 1
        title:
          type: string
          example: "Weekly Team Meeting"
        start_time:
          type: string
          format: date-time
          example: "2024-01-15T10:00:00Z"
        end_time:
          type: string
          format: date-time
          example: "2024-01-15T11:00:00Z"
        description:
          type: string
          example: "Weekly sync meeting for the development team"
        location:
          type: string
          example: "Conference Room A"
        uid:
          type: string
          example: "weekly-meeting-001@example.com"

    Group:
      type: object
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: "BCC Events"
        domain_key:
          type: string
          example: "exter"

    AssignmentRule:
      type: object
      properties:
        id:
          type: integer
          example: 1
        rule_type:
          type: string
          enum: [title_contains, description_contains]
          example: "title_contains"
        rule_value:
          type: string
          example: "Event"
        target_group_id:
          type: integer
          example: 1

    Filter:
      type: object
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: "BCC Events + Work Meetings"
        calendar_id:
          type: integer
          description: "Present for user calendar filters"
          example: 1
        domain_key:
          type: string
          description: "Present for domain calendar filters"
          example: "exter"
        username:
          type: string
          example: "john_doe"
        subscribed_event_ids:
          type: array
          items:
            type: integer
          example: [1, 2, 5]
        subscribed_group_ids:
          type: array
          items:
            type: integer
          example: [1, 3]
          description: "Only present for domain calendar filters"
        include_future_events:
          type: boolean
          nullable: true
          description: "For personal calendars only: If true, automatically include new recurring events added after filter creation. Not applicable to domain calendar filters."
          example: false
        link_uuid:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        export_url:
          type: string
          example: "/ical/550e8400-e29b-41d4-a716-446655440000.ics"

    Error:
      type: object
      properties:
        error:
          type: string
          example: "Invalid calendar URL"
        detail:
          type: string
          example: "The provided URL is not a valid iCal endpoint"