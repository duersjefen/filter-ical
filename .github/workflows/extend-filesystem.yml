name: Extend EBS Filesystem

on:
  workflow_dispatch:

jobs:
  extend-filesystem:
    name: Extend Filesystem to Use Full Disk Space
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: üîß Extend Filesystem on EC2 Instance
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "üîç Current disk usage:"
          df -h /
          echo ""

          echo "üîç Block devices:"
          lsblk
          echo ""

          # Detect root device
          ROOT_DEVICE=$(df / | tail -1 | awk '{print $1}')
          echo "üìç Root filesystem device: $ROOT_DEVICE"

          # Extract device and partition info
          if [[ $ROOT_DEVICE == /dev/nvme* ]]; then
            # NVMe device (e.g., /dev/nvme0n1p1)
            DEVICE=$(echo $ROOT_DEVICE | sed 's/p[0-9]*$//')
            PARTITION=$(echo $ROOT_DEVICE | sed 's/.*p//')
          else
            # Standard device (e.g., /dev/xvda1)
            DEVICE=$(echo $ROOT_DEVICE | sed 's/[0-9]*$//')
            PARTITION=$(echo $ROOT_DEVICE | sed 's/.*[^0-9]//')
          fi

          echo "üíæ Device: $DEVICE"
          echo "üìÇ Partition: $PARTITION"
          echo ""

          echo "üîß Extending partition..."
          sudo growpart $DEVICE $PARTITION || {
            echo "‚ö†Ô∏è  Partition already at maximum size or growpart failed"
          }
          echo ""

          # Detect filesystem type
          FS_TYPE=$(df -T / | tail -1 | awk '{print $2}')
          echo "üìÅ Filesystem type: $FS_TYPE"
          echo ""

          echo "üîß Resizing filesystem..."
          if [[ $FS_TYPE == "ext"* ]]; then
            sudo resize2fs $ROOT_DEVICE
          elif [[ $FS_TYPE == "xfs" ]]; then
            sudo xfs_growfs /
          else
            echo "‚ùå Unsupported filesystem type: $FS_TYPE"
            exit 1
          fi
          echo ""

          echo "‚úÖ Filesystem extended successfully!"
          echo ""
          echo "üîç New disk usage:"
          df -h /