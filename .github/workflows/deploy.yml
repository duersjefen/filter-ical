# =============================================================================
# Industry Standard Three-Tier Environment CI/CD Pipeline
# =============================================================================
#
# Development → Staging → Production
# 
# This implements the industry best practice of:
# 1. Fast feedback loop for development
# 2. Production-identical staging environment
# 3. Controlled production deployments with approval gates
#
# Environment Strategy:
# - development: Auto-deploy from any branch (fast feedback)
# - staging: Auto-deploy from main/master (integration testing)  
# - production: Manual approval required (safety gate)
#
# =============================================================================

name: Multi-Environment Deployment Pipeline

on:
  push:
    branches: [main, master, develop, feature/**]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

# Global environment variables (shared across all environments)
env:
  AWS_REGION: eu-north-1
  ECR_REGISTRY: ${{ vars.AWS_ACCOUNT_ID }}.dkr.ecr.eu-north-1.amazonaws.com

jobs:
  # =============================================================================
  # UNIT & CONTRACT TESTS (Always run first)
  # =============================================================================
  test:
    name: 🧪 Unit & Contract Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - uses: actions/checkout@v4
    
    - name: 🔧 Build Test Container
      run: |
        cd backend
        docker build -t test-backend --target test .
    
    - name: 🧪 Run Unit Tests
      run: |
        cd backend
        docker run --rm \
          -e ENV=test \
          -e DATABASE_URL=sqlite:///test.db \
          test-backend python3 -m pytest tests/ -m unit -v --tb=short
    
    - name: 📋 Run Contract Tests
      run: |
        cd backend
        docker run --rm \
          -e ENV=test \
          -e DATABASE_URL=sqlite:///test.db \
          test-backend python3 -m pytest tests/test_contracts.py -v --tb=short

  # =============================================================================
  # DEVELOPMENT ENVIRONMENT (Any branch)
  # =============================================================================
  deploy-development:
    name: 🚧 Deploy to Development
    needs: test
    runs-on: ubuntu-latest
    environment: development
    timeout-minutes: 10
    
    # Deploy development for any branch (fast feedback)
    if: github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: 🔐 Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/GitHubActionsRole
        role-session-name: GitHubActionsSession-Dev
        aws-region: ${{ env.AWS_REGION }}
    
    - name: 🔑 Login to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v2
    
    - name: 🏗️ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: 🏗️ Build and Push Branch Preview Images
      env:
        BRANCH_NAME: ${{ github.ref_name }}
        SAFE_BRANCH_NAME: ${{ github.ref_name }}
        IMAGE_TAG: dev-${{ github.sha }}
      run: |
        # Create safe branch name for container naming (replace / and special chars)
        SAFE_BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]')
        echo "🚧 Building branch preview: $BRANCH_NAME → $SAFE_BRANCH_NAME"
        echo "📍 Preview URL will be: https://$SAFE_BRANCH_NAME.dev.filter-ical.de"
        
        # Build applications first
        make ci-build
        
        # Build and push development containers
        docker build -t "$ECR_REGISTRY/filter-ical-backend:$IMAGE_TAG" \
          --cache-from "$ECR_REGISTRY/filter-ical-backend:dev-latest" \
          --build-arg BUILDKIT_INLINE_CACHE=1 backend/
        docker tag "$ECR_REGISTRY/filter-ical-backend:$IMAGE_TAG" "$ECR_REGISTRY/filter-ical-backend:dev-latest"
        
        docker build -t "$ECR_REGISTRY/filter-ical-frontend:$IMAGE_TAG" \
          --cache-from "$ECR_REGISTRY/filter-ical-frontend:dev-latest" \
          --build-arg BUILDKIT_INLINE_CACHE=1 frontend/
        docker tag "$ECR_REGISTRY/filter-ical-frontend:$IMAGE_TAG" "$ECR_REGISTRY/filter-ical-frontend:dev-latest"
        
        # Push to ECR
        docker push "$ECR_REGISTRY/filter-ical-backend:$IMAGE_TAG" &
        docker push "$ECR_REGISTRY/filter-ical-backend:dev-latest" &
        docker push "$ECR_REGISTRY/filter-ical-frontend:$IMAGE_TAG" &
        docker push "$ECR_REGISTRY/filter-ical-frontend:dev-latest" &
        wait
        
    - name: 📁 Sync Infrastructure to Development Server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: '.infra/docker/docker-compose.production.yml,.infra/docker/nginx.conf'
        target: '/opt/websites/'
        strip_components: 2
        
    - name: 🚀 Deploy Branch Preview to Development Server
      uses: ./.github/actions/execute-remote-docker
      with:
        containers: 'filter-ical-backend-dev filter-ical-frontend-dev'
        operation: 'deploy'
        nginx_restart: 'true'
        nginx_container: 'websites-nginx'
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
        EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        ECR_REGISTRY: ${{ env.ECR_REGISTRY }}
        IMAGE_TAG: dev-${{ github.sha }}
        BRANCH_NAME: ${{ github.ref_name }}
        AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
        AWS_REGION: ${{ env.AWS_REGION }}
        
    - name: 🧪 Validate Branch Preview Deployment
      env:
        BRANCH_NAME: ${{ github.ref_name }}
        SAFE_BRANCH_NAME: ${{ github.ref_name }}
      run: |
        SAFE_BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]')
        PREVIEW_URL="https://$SAFE_BRANCH_NAME.dev.filter-ical.de"
        echo "🎯 Branch Preview Ready!"
        echo "📍 Preview URL: $PREVIEW_URL"
        echo "🌿 Branch: $BRANCH_NAME"
        echo "💡 Share this URL to demo your feature!"

  # =============================================================================
  # STAGING ENVIRONMENT (main/master only)
  # =============================================================================
  deploy-staging:
    name: 🎭 Deploy to Staging
    needs: test
    runs-on: ubuntu-latest
    environment: staging
    timeout-minutes: 15
    outputs:
      backup_tag: ${{ steps.deploy-staging.outputs.BACKUP_TAG }}

    # Only deploy staging from main/master
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: 🔐 Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/GitHubActionsRole
        role-session-name: GitHubActionsSession-Staging
        aws-region: ${{ env.AWS_REGION }}
    
    - name: 🔑 Login to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v2
    
    - name: 🏗️ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: 🏗️ Build and Push Staging Images
      env:
        IMAGE_TAG: staging-${{ github.sha }}
      run: |
        echo "🎭 Building staging containers with tag: $IMAGE_TAG"
        
        # Build applications first
        make ci-build
        
        # Build and push staging containers
        docker build -t "$ECR_REGISTRY/filter-ical-backend:$IMAGE_TAG" \
          --cache-from "$ECR_REGISTRY/filter-ical-backend:staging-latest" \
          --build-arg BUILDKIT_INLINE_CACHE=1 backend/
        docker tag "$ECR_REGISTRY/filter-ical-backend:$IMAGE_TAG" "$ECR_REGISTRY/filter-ical-backend:staging-latest"
        
        docker build -t "$ECR_REGISTRY/filter-ical-frontend:$IMAGE_TAG" \
          --cache-from "$ECR_REGISTRY/filter-ical-frontend:staging-latest" \
          --build-arg BUILDKIT_INLINE_CACHE=1 frontend/
        docker tag "$ECR_REGISTRY/filter-ical-frontend:$IMAGE_TAG" "$ECR_REGISTRY/filter-ical-frontend:staging-latest"
        
        # Push to ECR
        docker push "$ECR_REGISTRY/filter-ical-backend:$IMAGE_TAG" &
        docker push "$ECR_REGISTRY/filter-ical-backend:staging-latest" &
        docker push "$ECR_REGISTRY/filter-ical-frontend:$IMAGE_TAG" &
        docker push "$ECR_REGISTRY/filter-ical-frontend:staging-latest" &
        wait
    
    - name: 📋 Calculate Infrastructure File Checksums
      run: |
        echo "🔍 Calculating checksums for infrastructure files..."
        mkdir -p .tmp
        
        # Calculate checksums
        sha256sum .infra/docker/docker-compose.production.yml > .tmp/compose-checksum.txt
        sha256sum .infra/docker/nginx.conf > .tmp/nginx-checksum.txt
        
        echo "📋 Expected checksums:"
        cat .tmp/compose-checksum.txt .tmp/nginx-checksum.txt
        
        # Add checksums to environment
        echo "EXPECTED_COMPOSE_CHECKSUM=$(cat .tmp/compose-checksum.txt | cut -d' ' -f1)" >> $GITHUB_ENV
        echo "EXPECTED_NGINX_CHECKSUM=$(cat .tmp/nginx-checksum.txt | cut -d' ' -f1)" >> $GITHUB_ENV

    - name: 📁 Sync Infrastructure to Staging Server  
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: '.infra/docker/docker-compose.production.yml,.infra/docker/nginx.conf'
        target: '/opt/websites/'
        strip_components: 2
    
    - name: 🔍 Validate Infrastructure Sync
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        envs: ECR_REGISTRY,AWS_ACCOUNT_ID,AWS_REGION,EXPECTED_COMPOSE_CHECKSUM,EXPECTED_NGINX_CHECKSUM
        script: |
          cd /opt/websites || { echo "❌ Failed to access /opt/websites"; exit 1; }
          
          echo "🔍 Validating infrastructure files after sync..."
          
          # Check critical files exist with proper permissions
          if [[ ! -f "docker-compose.production.yml" ]]; then
            echo "❌ CRITICAL: docker-compose.production.yml not found after sync!"
            ls -la
            exit 1
          fi
          
          if [[ ! -f "nginx.conf" ]]; then
            echo "❌ CRITICAL: nginx.conf not found after sync!"
            ls -la  
            exit 1
          fi
          
          # CHECKSUM VERIFICATION - Industry best practice
          echo "🔍 Verifying file integrity with checksums..."
          
          # Verify docker-compose file
          actual_compose_checksum=$(sha256sum docker-compose.production.yml | cut -d' ' -f1)
          if [[ "$actual_compose_checksum" != "$EXPECTED_COMPOSE_CHECKSUM" ]]; then
            echo "❌ CRITICAL: docker-compose.production.yml checksum mismatch!"
            echo "   Expected: $EXPECTED_COMPOSE_CHECKSUM"
            echo "   Actual:   $actual_compose_checksum"
            echo "   File was not properly synced to server"
            exit 1
          fi
          echo "✅ docker-compose.production.yml checksum verified"
          
          # Verify nginx file  
          actual_nginx_checksum=$(sha256sum nginx.conf | cut -d' ' -f1)
          if [[ "$actual_nginx_checksum" != "$EXPECTED_NGINX_CHECKSUM" ]]; then
            echo "❌ CRITICAL: nginx.conf checksum mismatch!"
            echo "   Expected: $EXPECTED_NGINX_CHECKSUM"  
            echo "   Actual:   $actual_nginx_checksum"
            echo "   File was not properly synced to server"
            exit 1
          fi
          echo "✅ nginx.conf checksum verified"
          
          echo "✅ All infrastructure files validated with checksum verification"
          
          # Validate docker-compose file with environment variables
          export AWS_ACCOUNT_ID="${AWS_ACCOUNT_ID}"
          export AWS_REGION="${AWS_REGION}"
          export ECR_REGISTRY="${ECR_REGISTRY}"
          
          # Create working docker-compose.yml from production file
          cp docker-compose.production.yml docker-compose.yml
          
          # Test docker-compose configuration parsing
          if ! docker-compose config >/dev/null 2>&1; then
            echo "❌ CRITICAL: docker-compose.yml configuration invalid after sync!"
            echo "🔍 Environment variables:"
            echo "   AWS_ACCOUNT_ID: $AWS_ACCOUNT_ID"
            echo "   AWS_REGION: $AWS_REGION"  
            echo "   ECR_REGISTRY: $ECR_REGISTRY"
            echo "🔍 Config validation errors:"
            docker-compose config
            exit 1
          fi
          
          echo "✅ docker-compose configuration valid"
          
          # Validate expected staging services are defined
          echo "🔍 Validating staging services..."
          services=$(docker-compose config --services)
          
          expected_services="filter-ical-backend-staging filter-ical-frontend-staging"
          missing_services=""
          
          for service in $expected_services; do
            if echo "$services" | grep -q "^${service}$"; then
              echo "   ✅ $service defined in compose file"
            else
              missing_services="$missing_services $service"
              echo "   ❌ $service missing from compose file"
            fi
          done
          
          if [ -n "$missing_services" ]; then
            echo "❌ CRITICAL: Missing staging services:$missing_services"
            echo "🔍 Available services:"
            echo "$services" | sed 's/^/   /'
            exit 1
          fi
          
          echo "✅ All staging services validated"
          echo "🎯 Infrastructure sync validation completed successfully"
        
    - name: 🚀 Deploy to Staging Server
      id: deploy-staging
      uses: ./.github/actions/execute-remote-docker
      with:
        containers: 'filter-ical-backend-staging filter-ical-frontend-staging'
        operation: 'deploy'
        nginx_restart: 'true'
        nginx_container: 'websites-nginx'
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
        EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        ECR_REGISTRY: ${{ env.ECR_REGISTRY }}
        IMAGE_TAG: staging-${{ github.sha }}
        AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
        AWS_REGION: ${{ env.AWS_REGION }}
    
    - name: 🧪 Validate Staging Deployment
      uses: ./.github/actions/validate-endpoints
      with:
        domain: 'staging.filter-ical.de'  # Staging environment
        endpoints: '/,/health,/domains/exter/groups'
        timeout: '30'
        retries: '5'

  # =============================================================================
  # AUTOMATIC ROLLBACK (Staging)
  # =============================================================================
  rollback-staging:
    name: 🔄 Staging Rollback
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment: staging
    if: failure() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
    - uses: actions/checkout@v4

    - name: 🔄 Execute Staging Rollback
      uses: ./.github/actions/rollback-deployment
      with:
        containers: 'filter-ical-backend-staging filter-ical-frontend-staging'
        backup_tag: ${{ needs.deploy-staging.outputs.backup_tag }}
        domain: 'staging.filter-ical.de'
        nginx_restart: 'true'
        nginx_container: 'websites-nginx'
        validation_endpoints: '/,/health'
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
        EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        ECR_REGISTRY: ${{ env.ECR_REGISTRY }}
        AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
        AWS_REGION: ${{ env.AWS_REGION }}

    - name: 📊 Rollback Summary
      if: always()
      run: |
        echo "================================================================================"
        echo "🔄 STAGING ROLLBACK EXECUTED"
        echo "================================================================================"
        echo "⚠️  Staging deployment failed - rolled back to previous version"
        echo "🏷️  Backup: ${{ needs.deploy-staging.outputs.backup_tag }}"
        echo "🌐 Domain: staging.filter-ical.de"
        echo "⏰ Rolled back at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "================================================================================"

  # =============================================================================
  # PRODUCTION ENVIRONMENT (Manual approval required)
  # =============================================================================
  deploy-production:
    name: 🌟 Deploy to Production
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 20
    outputs:
      backup_tag: ${{ steps.deploy-production.outputs.BACKUP_TAG }}

    # Only deploy production from main/master after staging succeeds
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: ⏰ Production Deployment Wait
      run: |
        echo "🌟 Production deployment starting..."
        echo "⏰ This deployment was approved after the mandatory wait period"
        echo "📋 Staging validation passed successfully"
    
    - name: 🔐 Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/GitHubActionsRole
        role-session-name: GitHubActionsSession-Production
        aws-region: ${{ env.AWS_REGION }}
    
    - name: 🔑 Login to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v2
    
    - name: 🏗️ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: 🏗️ Promote Staging Images to Production
      env:
        STAGING_TAG: staging-${{ github.sha }}
        PRODUCTION_TAG: ${{ github.sha }}
      run: |
        echo "🌟 Promoting staging images to production"
        echo "📋 Source: $STAGING_TAG → Target: $PRODUCTION_TAG"
        
        # Pull staging images
        docker pull "$ECR_REGISTRY/filter-ical-backend:$STAGING_TAG"
        docker pull "$ECR_REGISTRY/filter-ical-frontend:$STAGING_TAG"
        
        # Tag for production
        docker tag "$ECR_REGISTRY/filter-ical-backend:$STAGING_TAG" "$ECR_REGISTRY/filter-ical-backend:$PRODUCTION_TAG"
        docker tag "$ECR_REGISTRY/filter-ical-backend:$STAGING_TAG" "$ECR_REGISTRY/filter-ical-backend:latest"
        docker tag "$ECR_REGISTRY/filter-ical-frontend:$STAGING_TAG" "$ECR_REGISTRY/filter-ical-frontend:$PRODUCTION_TAG"
        docker tag "$ECR_REGISTRY/filter-ical-frontend:$STAGING_TAG" "$ECR_REGISTRY/filter-ical-frontend:latest"
        
        # Push production images
        docker push "$ECR_REGISTRY/filter-ical-backend:$PRODUCTION_TAG" &
        docker push "$ECR_REGISTRY/filter-ical-backend:latest" &
        docker push "$ECR_REGISTRY/filter-ical-frontend:$PRODUCTION_TAG" &
        docker push "$ECR_REGISTRY/filter-ical-frontend:latest" &
        wait
    
    - name: 📋 Calculate Infrastructure File Checksums
      run: |
        echo "🔍 Calculating checksums for infrastructure files..."
        mkdir -p .tmp
        
        # Calculate checksums
        sha256sum .infra/docker/docker-compose.production.yml > .tmp/compose-checksum.txt
        sha256sum .infra/docker/nginx.conf > .tmp/nginx-checksum.txt
        
        echo "📋 Expected checksums:"
        cat .tmp/compose-checksum.txt .tmp/nginx-checksum.txt
        
        # Add checksums to environment
        echo "EXPECTED_COMPOSE_CHECKSUM=$(cat .tmp/compose-checksum.txt | cut -d' ' -f1)" >> $GITHUB_ENV
        echo "EXPECTED_NGINX_CHECKSUM=$(cat .tmp/nginx-checksum.txt | cut -d' ' -f1)" >> $GITHUB_ENV

    - name: 📁 Sync Infrastructure to Production Server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: '.infra/docker/docker-compose.production.yml,.infra/docker/nginx.conf'
        target: '/opt/websites/'
        strip_components: 2
    
    - name: 🔍 Validate Infrastructure Sync
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        envs: ECR_REGISTRY,AWS_ACCOUNT_ID,AWS_REGION,EXPECTED_COMPOSE_CHECKSUM,EXPECTED_NGINX_CHECKSUM
        script: |
          cd /opt/websites || { echo "❌ Failed to access /opt/websites"; exit 1; }
          
          echo "🔍 Validating infrastructure files after sync..."
          
          # Check critical files exist with proper permissions
          if [[ ! -f "docker-compose.production.yml" ]]; then
            echo "❌ CRITICAL: docker-compose.production.yml not found after sync!"
            ls -la
            exit 1
          fi
          
          if [[ ! -f "nginx.conf" ]]; then
            echo "❌ CRITICAL: nginx.conf not found after sync!"
            ls -la  
            exit 1
          fi
          
          # CHECKSUM VERIFICATION - Industry best practice
          echo "🔍 Verifying file integrity with checksums..."
          
          # Verify docker-compose file
          actual_compose_checksum=$(sha256sum docker-compose.production.yml | cut -d' ' -f1)
          if [[ "$actual_compose_checksum" != "$EXPECTED_COMPOSE_CHECKSUM" ]]; then
            echo "❌ CRITICAL: docker-compose.production.yml checksum mismatch!"
            echo "   Expected: $EXPECTED_COMPOSE_CHECKSUM"
            echo "   Actual:   $actual_compose_checksum"
            echo "   File was not properly synced to server"
            exit 1
          fi
          echo "✅ docker-compose.production.yml checksum verified"
          
          # Verify nginx file  
          actual_nginx_checksum=$(sha256sum nginx.conf | cut -d' ' -f1)
          if [[ "$actual_nginx_checksum" != "$EXPECTED_NGINX_CHECKSUM" ]]; then
            echo "❌ CRITICAL: nginx.conf checksum mismatch!"
            echo "   Expected: $EXPECTED_NGINX_CHECKSUM"  
            echo "   Actual:   $actual_nginx_checksum"
            echo "   File was not properly synced to server"
            exit 1
          fi
          echo "✅ nginx.conf checksum verified"
          
          echo "✅ All infrastructure files validated with checksum verification"
          
          # Validate docker-compose file with environment variables
          export AWS_ACCOUNT_ID="${AWS_ACCOUNT_ID}"
          export AWS_REGION="${AWS_REGION}"
          export ECR_REGISTRY="${ECR_REGISTRY}"
          
          # Create working docker-compose.yml from production file
          cp docker-compose.production.yml docker-compose.yml
          
          # Test docker-compose configuration parsing
          if ! docker-compose config >/dev/null 2>&1; then
            echo "❌ CRITICAL: docker-compose.yml configuration invalid after sync!"
            echo "🔍 Environment variables:"
            echo "   AWS_ACCOUNT_ID: $AWS_ACCOUNT_ID"
            echo "   AWS_REGION: $AWS_REGION"  
            echo "   ECR_REGISTRY: $ECR_REGISTRY"
            echo "🔍 Config validation errors:"
            docker-compose config
            exit 1
          fi
          
          echo "✅ docker-compose configuration valid"
          
          # Validate expected production services are defined
          echo "🔍 Validating production services..."
          services=$(docker-compose config --services)
          
          expected_services="filter-ical filter-ical-frontend"
          missing_services=""
          
          for service in $expected_services; do
            if echo "$services" | grep -q "^${service}$"; then
              echo "   ✅ $service defined in compose file"
            else
              missing_services="$missing_services $service"
              echo "   ❌ $service missing from compose file"
            fi
          done
          
          if [ -n "$missing_services" ]; then
            echo "❌ CRITICAL: Missing production services:$missing_services"
            echo "🔍 Available services:"
            echo "$services" | sed 's/^/   /'
            exit 1
          fi
          
          echo "✅ All production services validated"
          echo "🎯 Infrastructure sync validation completed successfully"
        
    - name: 🚀 Deploy to Production Server
      id: deploy-production
      uses: ./.github/actions/execute-remote-docker
      with:
        containers: 'filter-ical filter-ical-frontend'
        operation: 'deploy'
        nginx_restart: 'true'
        nginx_container: 'websites-nginx'
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
        EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        ECR_REGISTRY: ${{ env.ECR_REGISTRY }}
        IMAGE_TAG: ${{ github.sha }}
        AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
        AWS_REGION: ${{ env.AWS_REGION }}
    
    - name: 🧪 Validate Production Deployment
      uses: ./.github/actions/validate-endpoints
      with:
        domain: ${{ vars.DOMAIN_NAME_VAR }}
        endpoints: '/,/health,/domains/exter/groups'
        timeout: '60'
        retries: '10'
    
    - name: 📊 Production Deployment Summary
      run: |
        echo "=================================================================================="
        echo "🌟 PRODUCTION DEPLOYMENT COMPLETED SUCCESSFULLY"
        echo "=================================================================================="
        echo "📊 Environment: Production"
        echo "🚀 Domain: ${{ vars.DOMAIN_NAME_VAR }}"
        echo "🏷️ Version: ${{ github.sha }}"
        echo "👤 Approved by: ${{ github.actor }}"
        echo "⏰ Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo ""
        echo "✅ Three-tier deployment pipeline completed:"
        echo "   1. ✅ Unit & Contract Tests passed"
        echo "   2. ✅ Staging deployment verified"
        echo "   3. ✅ Production deployment approved and deployed"
        echo "   4. ✅ Production validation successful"
        echo "=================================================================================="

  # =============================================================================
  # AUTOMATIC ROLLBACK (Production only)
  # =============================================================================
  rollback-production:
    name: 🔄 Emergency Production Rollback
    needs: deploy-production
    runs-on: ubuntu-latest
    environment: production
    if: failure() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: 🔄 Execute Emergency Rollback
      uses: ./.github/actions/rollback-deployment
      with:
        containers: 'filter-ical filter-ical-frontend'
        backup_tag: ${{ needs.deploy-production.outputs.backup_tag }}
        domain: ${{ vars.DOMAIN_NAME_VAR }}
        nginx_restart: 'true'
        nginx_container: 'websites-nginx'
        validation_endpoints: '/,/health'
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
        EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        ECR_REGISTRY: ${{ env.ECR_REGISTRY }}
        AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
        AWS_REGION: ${{ env.AWS_REGION }}

    - name: 📊 Rollback Summary
      if: always()
      run: |
        echo "================================================================================"
        echo "🚨 PRODUCTION EMERGENCY ROLLBACK EXECUTED"
        echo "================================================================================"
        echo "⚠️  Production deployment failed - rolled back to previous version"
        echo "🏷️  Backup: ${{ needs.deploy-production.outputs.backup_tag }}"
        echo "🌐 Domain: ${{ vars.DOMAIN_NAME_VAR }}"
        echo "⏰ Rolled back at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo ""
        echo "🔔 IMMEDIATE ACTION REQUIRED:"
        echo "   1. Verify production is stable at: https://${{ vars.DOMAIN_NAME_VAR }}"
        echo "   2. Review deployment logs for root cause"
        echo "   3. Fix issues before next deployment attempt"
        echo "================================================================================"