# =============================================================================
# iCal Viewer - Production Deployment Pipeline (Python + Vue 3)
# =============================================================================
# 
# This workflow provides robust, zero-downtime deployment of the iCal Viewer
# application to AWS infrastructure. It features:
#
# - Intelligent change detection to optimize deployment speed
# - Comprehensive health validation with fail-fast error handling  
# - Zero-downtime rolling updates
# - Extensive logging and debugging information
# - Multiple fallback strategies for reliability
#
# Architecture:
#   Domain: https://filter-ical.de
#   Infrastructure: AWS EC2 + ECR + Let's Encrypt SSL
#   Containers: nginx (reverse proxy) + backend (Python/FastAPI) + frontend (Vue 3/Vite)
#
# Security: Uses OIDC for AWS authentication (no hardcoded credentials)
# =============================================================================

name: Deploy Multi-App Infrastructure to AWS

on:
  push:
    branches: [main, master]  # Deploy on push to main branches
  pull_request:
    branches: [main, master]  # Test on PRs (deploy job only runs on main)
  workflow_dispatch:          # Allow manual triggering

# Environment configuration for consistent deployment
env:
  AWS_REGION: eu-north-1
  ECR_REGISTRY: 310829530903.dkr.ecr.eu-north-1.amazonaws.com
  ECR_REPOSITORY_BACKEND: ical-viewer-backend
  ECR_REPOSITORY_FRONTEND: ical-viewer-frontend
  DOMAIN_NAME: filter-ical.de
  DEPLOYMENT_TIMEOUT: 300  # 5 minutes max for deployments

permissions:
  id-token: write   # Required for requesting the JWT
  contents: read    # Required for actions/checkout

jobs:
  # ===========================================================================
  # TEST PHASE
  # ===========================================================================
  # Validates code quality before deployment. This job must pass for 
  # deployment to proceed.
  
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ§ª Execute all tests (Language Independent)
      run: |
        echo "ğŸš€ Running language-independent test suite..."
        
        # Use universal make targets that work with any language
        make ci-test

  # ===========================================================================
  # BUILD AND DEPLOYMENT PHASE
  # ===========================================================================
  # Only runs on main branch pushes after tests pass. Performs intelligent
  # builds and zero-downtime deployment with comprehensive validation.
  
  build-and-deploy:
    name: ğŸš€ Build & Deploy to Production
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials using OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::310829530903:role/GitHubActionsRole
        role-session-name: GitHubActionsSession
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Detect changed components
      id: changes
      run: |
        # =============================================================================
        # INTELLIGENT CHANGE DETECTION WITH ROBUST FALLBACKS
        # =============================================================================
        # This step determines which components need updating to optimize deployment
        # and avoid unnecessary container rebuilds. It uses multiple fallback 
        # strategies to handle different Git scenarios reliably.
        
        echo "ğŸ” Analyzing repository changes for targeted deployment..."
        
        # Function to detect changes with multiple fallback strategies
        detect_component_changes() {
          local component="$1"
          local pattern="$2"
          local output_var="${component}_changed"
          
          echo "ğŸ“ Checking for $component changes (pattern: $pattern)..."
          
          # Strategy 1: Compare with previous commit (ideal case)
          if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -E "$pattern" >/dev/null 2>&1; then
            echo "$output_var=true" >> $GITHUB_OUTPUT
            echo "âœ… $component changes detected (HEAD~1 comparison)"
            return 0
          fi
          
          # Strategy 2: Compare with origin/master (for PRs and shallow clones)
          if git diff --name-only origin/master HEAD 2>/dev/null | grep -E "$pattern" >/dev/null 2>&1; then
            echo "$output_var=true" >> $GITHUB_OUTPUT
            echo "âœ… $component changes detected (origin/master comparison)"
            return 0
          fi
          
          # Strategy 3: Check current commit only (fallback for single commits)
          if git show --name-only HEAD | grep -E "$pattern" >/dev/null 2>&1; then
            echo "$output_var=true" >> $GITHUB_OUTPUT
            echo "âœ… $component changes detected (HEAD commit analysis)"
            return 0
          fi
          
          # Strategy 4: FAIL-SAFE - Force update if detection uncertain
          echo "$output_var=true" >> $GITHUB_OUTPUT
          echo "âš ï¸  $component change detection uncertain - FORCING update for safety"
          echo "   This ensures deployment reliability over optimization"
          return 0
        }
        
        # Detect frontend changes (includes nginx config that affects frontend routing)
        detect_component_changes "frontend" "^frontend/|^infrastructure/production-nginx.conf"
        
        # Detect backend changes
        detect_component_changes "backend" "^backend/"
        
        # Summary of detection results
        echo ""
        echo "ğŸ“‹ Change Detection Summary:"
        echo "   Frontend: $([ "$(grep -o 'frontend_changed=true' <<<"$(cat $GITHUB_OUTPUT)")" ] && echo 'UPDATE REQUIRED' || echo 'No changes')"
        echo "   Backend:  $([ "$(grep -o 'backend_changed=true' <<<"$(cat $GITHUB_OUTPUT)")" ] && echo 'UPDATE REQUIRED' || echo 'No changes')"
        echo ""
    
    # ===========================================================================
    # PARALLEL BUILD OPTIMIZATION
    # ===========================================================================
    # Build frontend application and Docker containers concurrently for maximum speed
    
    - name: ğŸ—ï¸ Build applications (Language Independent)
      if: steps.changes.outputs.frontend_changed == 'true' || steps.changes.outputs.backend_changed == 'true'
      run: |
        echo "ğŸš€ Building applications using language-independent interface..."
        
        # Use universal make targets that work with any language
        make ci-build
    
    - name: ğŸ³ğŸŒ Build and push containers (parallel)
      if: steps.changes.outputs.backend_changed == 'true' || steps.changes.outputs.frontend_changed == 'true'
      env:
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "ğŸš€ Starting parallel container builds for maximum speed..."
        
        # Function to build backend container
        build_backend() {
          if [ "${{ steps.changes.outputs.backend_changed }}" == "true" ]; then
            echo "ğŸ“¦ Building backend container with advanced caching..."
            cd backend
            
            # Validate Docker environment and dependencies before build
            echo "ğŸ” Pre-build validation checks..."
            if ! docker --version >/dev/null 2>&1; then
              echo "âŒ Docker not available in CI environment"
              return 1
            fi
            
            if ! docker buildx version >/dev/null 2>&1; then
              echo "âŒ Docker Buildx not available in CI environment"  
              return 1
            fi
            
            # Verify essential files exist
            if [ ! -f "Dockerfile" ]; then
              echo "âŒ Backend Dockerfile missing - cannot build container"
              return 1
            fi
            
            if [ ! -f "requirements.txt" ]; then
              echo "âŒ Backend requirements.txt missing - cannot build container"
              return 1
            fi
            
            if [ ! -d "app" ]; then
              echo "âŒ Backend app directory missing - cannot build container"
              return 1
            fi
            
            echo "âœ… All pre-build validations passed"
            
            echo "âš™ï¸  Backend container build configuration:"
            echo "   Registry: $ECR_REGISTRY"
            echo "   Repository: $ECR_REPOSITORY_BACKEND"
            echo "   Tags: $IMAGE_TAG, latest"
            echo "   Platform: linux/amd64"
            echo "   Cache: GitHub Actions (GHA)"
            
            # Build with comprehensive error handling
            echo "ğŸ—ï¸  Starting robust backend container build..."
            
            if docker buildx build \
              --target production \
              --cache-from type=gha,scope=backend \
              --cache-to type=gha,scope=backend,mode=max \
              --platform linux/amd64 \
              --build-arg BUILDKIT_INLINE_CACHE=1 \
              --label "version=$IMAGE_TAG" \
              --label "build-date=$(date -u '+%Y-%m-%dT%H:%M:%SZ')" \
              --label "commit=$GITHUB_SHA" \
              --label "ci-system=github-actions" \
              --label "build-type=production" \
              -t $ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:$IMAGE_TAG \
              -t $ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:latest \
              --push .; then
              echo "âœ… Backend container built and pushed successfully"
              echo "ğŸ“Š Container details: $ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:$IMAGE_TAG"
              return 0
            else
              echo "âŒ Backend container build failed"
              echo "ğŸ” Build failure troubleshooting:"
              echo "   â€¢ Check Dockerfile syntax and Python requirements"
              echo "   â€¢ Verify requirements.txt format and dependencies"
              echo "   â€¢ Check ECR repository permissions and network connectivity"
              echo "   â€¢ Review Docker build logs above for specific errors"
              return 1
            fi
          else
            echo "â­ï¸  Backend unchanged, skipping container build"
            return 0
          fi
        }
        
        # Function to build frontend container
        build_frontend() {
          if [ "${{ steps.changes.outputs.frontend_changed }}" == "true" ]; then
            echo "ğŸ¨ Building frontend container with nginx configuration..."
            cd frontend
            
            # Docker build handles all frontend build steps - no need for local build
            echo "ğŸ“¦ Docker will handle all frontend build steps and dependencies"
            
            echo "âš™ï¸  Frontend container build configuration:"
            echo "   Registry: $ECR_REGISTRY"
            echo "   Repository: $ECR_REPOSITORY_FRONTEND"
            echo "   Tags: $IMAGE_TAG, latest"
            echo "   Platform: linux/amd64"
            echo "   Cache: GitHub Actions (GHA)"
            
            # Validate Docker environment and dependencies before build
            echo "ğŸ” Pre-build validation checks..."
            if ! docker --version >/dev/null 2>&1; then
              echo "âŒ Docker not available in CI environment"
              return 1
            fi
            
            if ! docker buildx version >/dev/null 2>&1; then
              echo "âŒ Docker Buildx not available in CI environment"  
              return 1
            fi
            
            # Verify essential files exist
            if [ ! -f "Dockerfile" ]; then
              echo "âŒ Frontend Dockerfile missing - cannot build container"
              return 1
            fi
            
            if [ ! -f "package.json" ]; then
              echo "âŒ Frontend package.json missing - cannot build container"
              return 1
            fi
            
            if [ ! -f "package-lock.json" ]; then
              echo "âŒ Frontend package-lock.json missing - regenerate with 'npm install'"
              return 1
            fi
            
            echo "âœ… All pre-build validations passed"
            
            # Build with comprehensive error handling and retry logic
            echo "ğŸ—ï¸  Starting robust frontend container build..."
            
            if docker buildx build \
              --cache-from type=gha,scope=frontend \
              --cache-to type=gha,scope=frontend,mode=max \
              --platform linux/amd64 \
              --build-arg BUILDKIT_INLINE_CACHE=1 \
              --label "version=$IMAGE_TAG" \
              --label "build-date=$(date -u '+%Y-%m-%dT%H:%M:%SZ')" \
              --label "commit=$GITHUB_SHA" \
              --label "ci-system=github-actions" \
              --label "build-type=production" \
              -t $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:$IMAGE_TAG \
              -t $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:latest \
              --push .; then
              echo "âœ… Frontend container built and pushed successfully"
              echo "ğŸ“Š Container details: $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:$IMAGE_TAG"
              return 0
            else
              echo "âŒ Frontend container build failed"
              echo "ğŸ” Build failure troubleshooting:"
              echo "   â€¢ Check Dockerfile syntax and dependencies"
              echo "   â€¢ Verify package.json and package-lock.json are synchronized"
              echo "   â€¢ Check ECR repository permissions and network connectivity"
              echo "   â€¢ Review Docker build logs above for specific errors"
              return 1
            fi
          else
            echo "â­ï¸  Frontend unchanged, skipping container build"
            return 0
          fi
        }
        
        # Execute builds in parallel background jobs
        echo "ğŸ”„ Starting parallel build execution..."
        build_backend &
        BACKEND_PID=$!
        
        build_frontend &
        FRONTEND_PID=$!
        
        # Wait for both builds to complete
        echo "â³ Waiting for parallel builds to complete..."
        
        BACKEND_EXIT=0
        FRONTEND_EXIT=0
        
        # Wait for backend build
        if wait $BACKEND_PID; then
          echo "âœ… Backend build completed successfully"
        else
          BACKEND_EXIT=$?
          echo "âŒ Backend build failed with exit code $BACKEND_EXIT"
        fi
        
        # Wait for frontend build
        if wait $FRONTEND_PID; then
          echo "âœ… Frontend build completed successfully"
        else
          FRONTEND_EXIT=$?
          echo "âŒ Frontend build failed with exit code $FRONTEND_EXIT"
        fi
        
        # Check overall success
        if [ $BACKEND_EXIT -eq 0 ] && [ $FRONTEND_EXIT -eq 0 ]; then
          echo "ğŸ‰ All parallel builds completed successfully!"
          echo "âš¡ Build time saved through parallelization"
        else
          echo "ğŸ’¥ Parallel build failed - Backend: $BACKEND_EXIT, Frontend: $FRONTEND_EXIT"
          exit 1
        fi

    - name: ğŸ—ï¸  Prepare production environment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        command_timeout: 5m
        script: |
          # =======================================================================
          # PRODUCTION ENVIRONMENT PREPARATION
          # =======================================================================
          
          echo "ğŸš€ Initializing production environment preparation..."
          
          # Create production directory structure with proper permissions
          echo "ğŸ“ Setting up production directory structure..."
          sudo mkdir -p /opt/websites/{nginx,scripts,apps/ical-viewer,backups,logs}
          sudo chown -R ec2-user:ec2-user /opt/websites
          echo "   âœ… Directory structure created"
          
          # Clean up legacy deployment directories (graceful migration)
          echo "ğŸ§¹ Cleaning up legacy deployment directories..."
          for legacy_dir in "/opt/ical-viewer" "/opt/multi-apps"; do
            if [ -d "$legacy_dir" ]; then
              echo "   ğŸ”„ Stopping services in $legacy_dir"
              (cd "$legacy_dir" && docker-compose down 2>/dev/null) || true
            fi
          done
          echo "   âœ… Legacy cleanup completed"
          
          # Initialize production directory
          cd /opt/websites
          echo "ğŸ“‹ Current directory: $(pwd)"
          
          # Create production environment configuration
          echo "âš™ï¸  Creating production environment configuration..."
          cat > .env << 'EOF'
          # Production Environment Configuration
          AWS_ACCOUNT_ID=310829530903
          AWS_REGION=eu-north-1
          COMPOSE_PROJECT_NAME=websites
          DOCKER_BUILDKIT=1
          EOF
          echo "   âœ… Environment configuration created"
          
          # Authenticate with ECR
          echo "ğŸ” Authenticating with Amazon ECR..."
          if aws ecr get-login-password --region eu-north-1 | docker login --username AWS --password-stdin 310829530903.dkr.ecr.eu-north-1.amazonaws.com; then
            echo "   âœ… ECR authentication successful"
          else
            echo "   âŒ ECR authentication failed"
            exit 1
          fi
          
          # =============================================================================
          # CREATE BACKUP OF CURRENT DEPLOYMENT (For Rollback Safety)
          # =============================================================================
          echo "ğŸ’¾ Creating backup of current deployment for rollback safety..."
          
          # Check if containers are currently running
          if docker-compose ps | grep -q "Up"; then
            echo "ğŸ“¦ Current deployment detected - creating backup snapshots..."
            
            # Create backup tags for current images
            BACKEND_CURRENT=$(docker-compose images ical-viewer | tail -n 1 | awk '{print $4":"$5}' 2>/dev/null || echo "")
            FRONTEND_CURRENT=$(docker-compose images ical-viewer-frontend | tail -n 1 | awk '{print $4":"$5}' 2>/dev/null || echo "")
            
            if [ -n "$BACKEND_CURRENT" ] && [ "$BACKEND_CURRENT" != ":" ]; then
              docker tag "$BACKEND_CURRENT" "${BACKEND_CURRENT%:*}:backup-ical-viewer" 2>/dev/null || true
              echo "   âœ… Backend backup created: backup-ical-viewer"
            fi
            
            if [ -n "$FRONTEND_CURRENT" ] && [ "$FRONTEND_CURRENT" != ":" ]; then
              docker tag "$FRONTEND_CURRENT" "${FRONTEND_CURRENT%:*}:backup-ical-viewer-frontend" 2>/dev/null || true
              echo "   âœ… Frontend backup created: backup-ical-viewer-frontend"
            fi
          else
            echo "   â„¹ï¸  No current deployment running - no backup needed"
          fi
          
          # Pre-pull latest container images
          echo "ğŸ“¥ Pre-pulling latest container images..."
          
          echo "   ğŸ“¦ Pulling backend image..."
          if docker pull 310829530903.dkr.ecr.eu-north-1.amazonaws.com/ical-viewer-backend:latest; then
            echo "   âœ… Backend image pulled successfully"
          else
            echo "   âŒ Backend image pull failed"
            exit 1
          fi
          
          echo "   ğŸ¨ Pulling frontend image..."
          if docker pull 310829530903.dkr.ecr.eu-north-1.amazonaws.com/ical-viewer-frontend:latest; then
            echo "   âœ… Frontend image pulled successfully"
          else
            echo "   âŒ Frontend image pull failed"
            exit 1
          fi
          
          echo "âœ… Production environment preparation completed successfully"
    
    - name: ğŸ“¤ Deploy configuration files to production
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "infrastructure/production-nginx.conf,infrastructure/production-docker-compose.yml"
        target: "/opt/websites/"
        strip_components: 1
        timeout: 30s
        use_insecure_cipher: false
    
    - name: Deploy Production Website Infrastructure
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd /opt/websites
          
          # =============================================================================
          # PRODUCTION DEPLOYMENT ORCHESTRATION
          # =============================================================================
          
          echo "ğŸš€ Starting production deployment orchestration..."
          
          # Prepare configuration files with validation
          echo "ğŸ“‹ Preparing configuration files..."
          
          if [ -f "production-docker-compose.yml" ]; then
            mv production-docker-compose.yml docker-compose.yml
            echo "   âœ… Docker Compose configuration updated"
          else
            echo "   âš ï¸  No new Docker Compose config found, using existing"
          fi
          
          if [ -f "production-nginx.conf" ]; then
            mkdir -p nginx
            mv production-nginx.conf nginx/nginx.conf
            echo "   âœ… Nginx configuration updated"
          else
            echo "   âš ï¸  No new Nginx config found, using existing"
          fi
          
          # Validate docker-compose configuration
          echo "ğŸ” Validating Docker Compose configuration..."
          if docker-compose config -q; then
            echo "   âœ… Docker Compose configuration is valid"
          else
            echo "   âŒ Docker Compose configuration is invalid!"
            exit 1
          fi
          
          # Smart container update strategy
          CONTAINERS_TO_UPDATE=""
          BACKEND_CHANGED="${{ steps.changes.outputs.backend_changed }}"
          FRONTEND_CHANGED="${{ steps.changes.outputs.frontend_changed }}"
          
          echo "ğŸ“¦ Determining container update strategy..."
          
          if [[ "$BACKEND_CHANGED" == "true" ]]; then
            CONTAINERS_TO_UPDATE="$CONTAINERS_TO_UPDATE ical-viewer"
            echo "   ğŸ“± Backend changes detected - ical-viewer container will be updated"
          fi
          
          if [[ "$FRONTEND_CHANGED" == "true" ]]; then
            CONTAINERS_TO_UPDATE="$CONTAINERS_TO_UPDATE ical-viewer-frontend"
            echo "   ğŸ¨ Frontend changes detected - ical-viewer-frontend container will be updated"
          fi
          
          # Execute deployment strategy
          if [[ -z "$CONTAINERS_TO_UPDATE" ]]; then
            echo "âœ¨ No application containers require updating - deployment complete"
            echo "ğŸ” Current container status:"
            docker-compose ps
          else
            echo "ğŸ”„ Executing rolling update for containers:$CONTAINERS_TO_UPDATE"
            
            # Pull latest images
            echo "ğŸ“¥ Pulling latest container images..."
            docker-compose pull$CONTAINERS_TO_UPDATE
            
            # Perform rolling update (no downtime)
            echo "ğŸ”„ Performing zero-downtime rolling update..."
            docker-compose up -d --no-deps$CONTAINERS_TO_UPDATE
            
            # Initial service stabilization
            echo "â³ Allowing services to stabilize..."
            sleep 30
            
            # Display current status
            echo "ğŸ” Post-deployment container status:"
            docker-compose ps
            
            # Check for any failed containers
            if docker-compose ps | grep -q "Exit\|unhealthy"; then
              echo "âŒ Some containers failed to start properly!"
              docker-compose logs --tail=50
              exit 1
            else
              echo "âœ… All containers started successfully"
            fi
            
            # Restart nginx to ensure it picks up new container configurations
            echo "ğŸ”„ Restarting nginx to refresh configuration..."
            docker-compose restart nginx
            sleep 5
          fi
          
          # =============================================================================
          # COMPREHENSIVE DEPLOYMENT VALIDATION
          # =============================================================================
          # These health checks ensure the deployment is actually working before
          # declaring success. Any failure will abort the deployment.
          
          echo "ğŸ§ª Running comprehensive production validation..."
          
          # Smart wait for backend initialization with health checks
          echo "â³ Waiting for backend initialization (Python FastAPI startup)..."
          
          # Wait up to 3 minutes for backend to be fully ready
          MAX_WAIT=180
          WAIT_COUNT=0
          
          while [ $WAIT_COUNT -lt $MAX_WAIT ]; do
            if curl -f --connect-timeout 5 --max-time 10 http://localhost:3000/health > /dev/null 2>&1; then
              echo "   âœ… Backend is ready after ${WAIT_COUNT}s"
              break
            fi
            
            if [ $((WAIT_COUNT % 15)) -eq 0 ]; then
              echo "   â³ Still waiting for backend (${WAIT_COUNT}s elapsed)..."
            fi
            
            sleep 5
            WAIT_COUNT=$((WAIT_COUNT + 5))
          done
          
          if [ $WAIT_COUNT -ge $MAX_WAIT ]; then
            echo "   âš ï¸  Backend took longer than expected to start, proceeding with validation"
          fi
          
          # Initialize validation tracking
          VALIDATION_FAILED=0
          
          # Test 1: HTTPS Site Response
          echo "ğŸŒ Test 1/6: HTTPS site accessibility..."
          if curl -f --connect-timeout 10 --max-time 30 https://filter-ical.de/ > /dev/null 2>&1; then
            echo "   âœ… HTTPS site responding correctly"
          else
            echo "   âŒ HTTPS site not responding"
            VALIDATION_FAILED=1
          fi
          
          # Test 2: JavaScript Bundle Loading
          echo "ğŸ“„ Test 2/6: Frontend JavaScript delivery..."
          if curl -f --connect-timeout 10 --max-time 30 https://filter-ical.de/js/main.js > /dev/null 2>&1; then
            echo "   âœ… JavaScript bundle loading correctly"
          else
            echo "   âŒ JavaScript bundle not accessible"
            VALIDATION_FAILED=1
          fi
          
          # Test 3: Backend Health Endpoint
          echo "ğŸ”§ Test 3/6: Backend health endpoint..."
          if curl -f --connect-timeout 10 --max-time 30 https://filter-ical.de/health > /dev/null 2>&1; then
            echo "   âœ… Backend health check passed"
          else
            echo "   âŒ Backend health check failed"
            VALIDATION_FAILED=1
          fi
          
          # Test 4: Full Page Content Validation
          echo "ğŸ“Š Test 4/6: Full page content integrity..."
          PAGE_CONTENT=$(curl -s --connect-timeout 10 --max-time 30 https://filter-ical.de/ 2>/dev/null || echo "")
          PAGE_SIZE=${#PAGE_CONTENT}
          
          if [ "$PAGE_SIZE" -gt 1000 ]; then
            echo "   âœ… Page content complete ($PAGE_SIZE bytes)"
          else
            echo "   âŒ Page content incomplete or missing (only $PAGE_SIZE bytes)"
            VALIDATION_FAILED=1
          fi
          
          # Validate critical resources are accessible (catches deployment issues)
          echo "ğŸ” Test 4.1/6: Checking frontend assets accessibility..."
          
          # Check for Vite-generated assets in /assets/ directory (modern SPA build)
          if curl -f --connect-timeout 5 --max-time 15 "https://filter-ical.de/assets/" > /dev/null 2>&1; then
            echo "   âœ… /assets/ directory accessible"
          else
            echo "   âŒ /assets/ directory not accessible - frontend may not be deployed"
            VALIDATION_FAILED=1
          fi
          
          # Check backend API endpoint
          if curl -f --connect-timeout 5 --max-time 15 "https://filter-ical.de/api/calendars" > /dev/null 2>&1; then
            echo "   âœ… /api/calendars accessible"
          else
            echo "   âŒ /api/calendars not accessible - backend may not be deployed"
            VALIDATION_FAILED=1
          fi
          
          # Test 5: Application Initialization Check
          echo "âš¡ Test 5/6: Application initialization..."
          if echo "$PAGE_CONTENT" | grep -q "iCal.*Viewer\|login\|calendar" 2>/dev/null; then
            echo "   âœ… Application appears to be initializing correctly"
          else
            echo "   âŒ Application may not be initializing properly"
            VALIDATION_FAILED=1
          fi
          
          # Test 6: SSL Certificate Validation
          echo "ğŸ”’ Test 6/6: SSL certificate validation..."
          if curl -s --connect-timeout 10 --max-time 30 -I https://filter-ical.de/ | grep -q "HTTP/[12].[01] 200" 2>/dev/null; then
            echo "   âœ… SSL certificate and HTTPS working correctly"
          else
            echo "   âŒ SSL/HTTPS configuration issue detected"
            VALIDATION_FAILED=1
          fi
          
          # Final validation result
          echo ""
          if [ "$VALIDATION_FAILED" -eq 0 ]; then
            echo "âœ… ALL VALIDATION TESTS PASSED - Deployment successful!"
            echo "ğŸŒ Your website is fully operational at: https://filter-ical.de"
            
            # Clean up backup containers since deployment succeeded
            if docker images | grep -q "backup-"; then
              echo "ğŸ§¹ Cleaning up backup containers after successful deployment..."
              docker images --format "table {{.Repository}}:{{.Tag}}" | grep "backup-" | xargs -r docker rmi 2>/dev/null || true
            fi
          else
            echo "âŒ DEPLOYMENT VALIDATION FAILED - Initiating automatic rollback"
            echo "ğŸ” Check the test results above to identify the issue"
            
            # =============================================================================
            # AUTOMATIC ROLLBACK MECHANISM
            # =============================================================================
            echo "ğŸ”„ Starting automatic rollback to previous working version..."
            
            # Check if backup containers exist
            if docker images | grep -q "backup-"; then
              echo "ğŸ“¦ Found backup containers, rolling back..."
              
              # Stop current failed containers
              docker-compose stop ical-viewer ical-viewer-frontend 2>/dev/null || true
              
              # Tag backup images back to latest
              for container in ical-viewer ical-viewer-frontend; do
                BACKUP_IMAGE=$(docker images --format "table {{.Repository}}:{{.Tag}}" | grep "backup-$container" | head -1 | awk '{print $1}')
                if [ -n "$BACKUP_IMAGE" ]; then
                  ECR_REPO=$(echo $BACKUP_IMAGE | cut -d: -f1)
                  echo "   ğŸ”„ Restoring $container from backup..."
                  docker tag "$BACKUP_IMAGE" "$ECR_REPO:latest"
                fi
              done
              
              # Restart with backup images
              docker-compose up -d ical-viewer ical-viewer-frontend
              
              # Wait for rollback to stabilize
              echo "â³ Waiting for rollback to stabilize..."
              sleep 15
              
              # Quick validation of rollback
              if curl -f --connect-timeout 10 --max-time 20 https://filter-ical.de/health > /dev/null 2>&1; then
                echo "âœ… AUTOMATIC ROLLBACK SUCCESSFUL"
                echo "ğŸŒ Previous version restored at: https://filter-ical.de"
                echo "âš ï¸  Please fix the issues above before attempting deployment again"
              else
                echo "âŒ ROLLBACK FAILED - Manual intervention required"
                echo "ğŸ†˜ Both current and previous versions are non-functional"
              fi
              
              # Clean up failed deployment images
              docker images --format "table {{.Repository}}:{{.Tag}}" | grep ":latest" | grep -E "(ical-viewer-backend|ical-viewer-frontend)" | xargs -r docker rmi --force 2>/dev/null || true
              
            else
              echo "âš ï¸  No backup containers found - cannot rollback automatically"
              echo "ğŸ’¡ The deployment failed but no previous version backup exists"
            fi
            
            exit 1
          fi
          
          # Clean up old images to save space
          docker image prune -af --filter "until=24h"
          
          echo "âœ… Production deployment completed!"
          echo "ğŸŒ Your website is live at: https://filter-ical.de"
    
    # ===========================================================================
    # DEPLOYMENT COMPLETION NOTIFICATION
    # ===========================================================================
    # Provides clear feedback on deployment status with actionable information
    
    - name: ğŸ“¢ Notify deployment status
      if: always()
      run: |
        echo "================================================================================="
        echo "ğŸ DEPLOYMENT PIPELINE COMPLETED"
        echo "================================================================================="
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… STATUS: SUCCESSFUL"
          echo "ğŸŒ LIVE SITE: https://${{ env.DOMAIN_NAME }}/"
          echo "ğŸ—ï¸  ARCHITECTURE: Multi-container Docker with nginx reverse proxy"
          echo "ğŸ”’ SECURITY: Let's Encrypt SSL with comprehensive security headers"
          echo "âš¡ FEATURES: Zero-downtime rolling updates with health validation"
          echo "ğŸ”„ ROLLBACK: Automatic rollback on deployment failure"
          echo ""
          echo "ğŸ¯ Next steps:"
          echo "   â€¢ Test the live application functionality"
          echo "   â€¢ Monitor application logs if needed"
          echo "   â€¢ Check SSL certificate status"
        else
          echo "âŒ STATUS: FAILED"
          echo "ğŸ” TROUBLESHOOTING:"
          echo "   â€¢ Check the workflow logs above for specific error details"
          echo "   â€¢ Verify AWS credentials and permissions"
          echo "   â€¢ Ensure EC2 instance is accessible and healthy"
          echo "   â€¢ Check Docker container status on production server"
          echo "ğŸ†˜ IMPACT: Automatic rollback initiated to maintain service availability"
          exit 1
        fi
        
        echo "================================================================================="