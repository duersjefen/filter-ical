name: Renew SSL Certificate

on:
  workflow_dispatch:
    inputs:
      confirm_renewal:
        description: 'Type "YES" to confirm certificate renewal'
        required: true
        type: string

jobs:
  renew-certificate:
    if: github.event.inputs.confirm_renewal == 'YES'
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: üîê Renew Let's Encrypt Certificate
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          debug: true
          script: |
            echo "üîê Renewing Let's Encrypt certificate with staging subdomain..."

            cd /opt/websites || { echo "‚ùå Failed to access /opt/websites"; exit 1; }

            # Check current certificate
            echo "üìã Current certificate domains:"
            docker exec websites-nginx openssl x509 -in /etc/letsencrypt/live/filter-ical.de/fullchain.pem -text -noout | grep "DNS:" || true

            # Stop nginx temporarily (certbot needs port 80)
            echo "üõë Stopping nginx..."
            docker-compose stop nginx

            # Run certbot to expand certificate
            echo "üîÑ Running certbot to expand certificate..."
            docker run --rm \
              -v websites-letsencrypt-certs:/etc/letsencrypt \
              -v websites-certbot-webroot:/var/www/certbot \
              -p 80:80 \
              certbot/certbot certonly \
                --standalone \
                --expand \
                --non-interactive \
                --agree-tos \
                --email martijn@filter-ical.de \
                -d filter-ical.de \
                -d www.filter-ical.de \
                -d staging.filter-ical.de

            # Start nginx
            echo "üöÄ Starting nginx..."
            docker-compose start nginx

            # Wait for nginx to start
            sleep 5

            # Verify nginx configuration
            echo "üîç Verifying nginx configuration..."
            docker exec websites-nginx nginx -t || {
              echo "‚ùå Nginx config test failed!"
              exit 1
            }

            # Reload nginx to pick up new certificate
            echo "üîÑ Reloading nginx..."
            docker exec websites-nginx nginx -s reload || {
              echo "‚ùå Nginx reload failed!"
              exit 1
            }

            # Wait for nginx to stabilize
            sleep 3

            # Check new certificate
            echo "‚úÖ New certificate domains:"
            docker exec websites-nginx openssl x509 -in /etc/letsencrypt/live/filter-ical.de/fullchain.pem -text -noout | grep "DNS:" || {
              echo "‚ö†Ô∏è Could not read certificate (may still be valid)"
            }

            # Verify HTTPS works
            echo "üß™ Testing HTTPS connectivity..."
            curl -sf --max-time 10 https://filter-ical.de/health || {
              echo "‚ùå Production HTTPS not responding!"
              exit 1
            }
            curl -sf --max-time 10 https://staging.filter-ical.de/health || {
              echo "‚ùå Staging HTTPS not responding!"
              exit 1
            }

            echo "‚úÖ Certificate renewal completed!"