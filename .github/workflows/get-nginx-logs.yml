name: Get Nginx Logs

on:
  workflow_dispatch:

jobs:
  get-logs:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /opt/websites

            echo "ðŸ” Container Status:"
            docker ps -a | grep -E "nginx|certbot"

            echo ""
            echo "ðŸ“‹ Last 50 lines of nginx container logs:"
            docker logs --tail 50 websites-nginx 2>&1 || echo "Container not found or no logs"

            echo ""
            echo "ðŸ§ª Testing nginx config directly:"
            docker run --rm \
              -v /opt/websites/nginx.conf:/etc/nginx/nginx.conf:ro \
              -v websites-letsencrypt-certs:/etc/letsencrypt:ro \
              nginx:alpine nginx -t 2>&1 || echo "Config test failed"

            echo ""
            echo "ðŸ” Certificate files:"
            docker run --rm \
              -v websites-letsencrypt-certs:/etc/letsencrypt:ro \
              nginx:alpine ls -la /etc/letsencrypt/live/filter-ical.de/ 2>&1 || echo "Cert directory not accessible"

            echo ""
            echo "ðŸ“œ Certificate domains:"
            docker run --rm \
              -v websites-letsencrypt-certs:/etc/letsencrypt:ro \
              nginx:alpine openssl x509 -in /etc/letsencrypt/live/filter-ical.de/fullchain.pem -text -noout 2>&1 | grep -A 1 "Subject Alternative Name" || echo "Cannot read certificate"