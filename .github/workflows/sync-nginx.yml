name: Sync Nginx Config
on:
  workflow_dispatch:

jobs:
  sync:
    name: üîÑ Sync Nginx
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: üìÅ Sync Nginx Config to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: '.infra/docker/nginx.conf'
          target: '/opt/websites/'
          strip_components: 2

      - name: üîÑ Recreate Nginx Container with New Config
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /opt/websites

            echo "üîÑ Stopping nginx container..."
            docker stop websites-nginx || true

            echo "üóëÔ∏è  Removing old nginx container..."
            docker rm websites-nginx || true

            echo "üöÄ Recreating nginx with new config..."
            docker-compose up -d websites-nginx

            echo "‚è≥ Waiting for nginx to start..."
            sleep 10

            echo "üìã Nginx status:"
            docker ps --filter "name=nginx" --format "table {{.Names}}\t{{.Status}}"

            echo "üîç Nginx logs (last 10 lines):"
            docker logs --tail 10 websites-nginx 2>&1

            echo ""
            echo "üîç Testing endpoints:"
            curl -f -s -o /dev/null -w "Homepage: %{http_code}\n" --max-time 10 https://filter-ical.de/ || echo "Homepage: FAILED"
            curl -f -s -o /dev/null -w "Health: %{http_code}\n" --max-time 10 https://filter-ical.de/health || echo "Health: FAILED"