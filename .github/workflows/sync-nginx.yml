name: Sync Nginx Config
on:
  workflow_dispatch:

jobs:
  sync:
    name: ğŸ”„ Sync Nginx
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ“ Sync Nginx Config to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: '.infra/docker/nginx.conf'
          target: '/opt/websites/'
          strip_components: 2

      - name: ğŸ”„ Restart Nginx Container
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸ”„ Restarting nginx with new config..."
            docker restart websites-nginx

            echo "â³ Waiting for nginx..."
            sleep 5

            echo "ğŸ“‹ Nginx status:"
            docker ps --filter "name=nginx" --format "table {{.Names}}\t{{.Status}}"

            echo "ğŸ” Testing endpoints:"
            curl -f -s -o /dev/null -w "Homepage: %{http_code}\n" --max-time 10 https://filter-ical.de/ || echo "Homepage: FAILED"
            curl -f -s -o /dev/null -w "Health: %{http_code}\n" --max-time 10 https://filter-ical.de/health || echo "Health: FAILED"