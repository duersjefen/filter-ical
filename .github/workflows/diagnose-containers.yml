name: Diagnose Container Issues
on:
  workflow_dispatch:

jobs:
  diagnose:
    name: 🔍 Diagnose
    runs-on: ubuntu-latest
    steps:
      - name: 🔍 Check Container Status and Logs
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "📊 Container status:"
            docker ps -a --filter "name=filter-ical" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

            echo ""
            echo "🔍 Backend logs (last 50 lines):"
            docker logs --tail 50 filter-ical 2>&1 || echo "No logs"

            echo ""
            echo "🔍 Frontend logs (last 50 lines):"
            docker logs --tail 50 filter-ical-frontend 2>&1 || echo "No logs"

            echo ""
            echo "🔍 Nginx logs (last 30 lines):"
            docker logs --tail 30 websites-nginx 2>&1 || echo "No logs"

            echo ""
            echo "🔍 Test from inside server:"
            curl -v http://localhost:3000/health 2>&1 || echo "Backend not responding"

            echo ""
            echo "🔍 Docker network:"
            docker network inspect websites_default || echo "Network issue"