#!/bin/bash
# =============================================================================  
# Git Pre-commit Hook - Automated Quality Gate (Python + Vue 3)
# =============================================================================
# This runs automatically before every git commit to ensure code quality.
# Install: git config core.hooksPath .githooks

set -e

echo "üîç Running pre-commit quality checks..."

# 1. Backend Tests (if backend files changed)
if git diff --cached --name-only | grep -q "^backend/"; then
    echo "üìä Backend files changed - running Python tests..."
    cd backend
    if ! source venv/bin/activate && python3 -m pytest tests/ -v >/dev/null 2>&1; then
        echo "‚ùå Backend tests failed! Commit aborted."
        exit 1
    fi
    echo "‚úÖ Backend tests passed"
    cd ..
fi

# 2. Frontend Build Check (if frontend files changed)  
if git diff --cached --name-only | grep -q "^frontend/"; then
    echo "üé® Frontend files changed - checking Vue 3 build..."
    cd frontend
    if ! npm run build >/dev/null 2>&1; then
        echo "‚ùå Frontend build failed! Commit aborted."
        exit 1
    fi
    echo "‚úÖ Frontend build successful"
    cd ..
fi

# 3. Python linting (optional - only if available)
if command -v flake8 >/dev/null 2>&1; then
    if ! flake8 backend/app backend/tests >/dev/null 2>&1; then
        echo "‚ö†Ô∏è  Python linting warnings found (not blocking commit)"
    fi
fi

echo "‚úÖ All quality checks passed - commit proceeding"