#!/bin/bash
# =============================================================================  
# Git Pre-commit Hook - Universal Quality Gate (Language Independent)
# =============================================================================
# This runs automatically before every git commit to ensure code quality.
# Works with any language through standardized Docker containers and Make targets.
# Install: git config core.hooksPath .githooks

set -e

echo "ğŸ” Running universal pre-commit quality checks..."

# Check if there are any changes staged for commit
if ! git diff --cached --quiet; then
    echo "ğŸ“‹ Changes detected, running validation..."
    
    # =========================================================================
    # DEPENDENCY SYNCHRONIZATION VALIDATION
    # =========================================================================
    # Prevent package-lock.json sync issues that can break CI/CD
    echo "ğŸ”§ Validating dependency synchronization..."
    
    # Check frontend package-lock.json sync
    if [ -f "frontend/package.json" ] && [ -f "frontend/package-lock.json" ]; then
        if git diff --cached --name-only | grep -q "frontend/package.json"; then
            echo "âš ï¸  Frontend package.json modified - checking package-lock.json sync"
            cd frontend
            if ! npm ci --dry-run >/dev/null 2>&1; then
                echo "âŒ Frontend package.json and package-lock.json are out of sync!"
                echo "ğŸ”§ Fix this by running: cd frontend && rm package-lock.json && npm install"
                echo "   Then add the updated package-lock.json to your commit"
                exit 1
            fi
            cd ..
            echo "âœ… Frontend dependencies are synchronized"
        fi
    fi
    
    # Check backend requirements.txt for malformed lines
    if [ -f "backend/requirements.txt" ]; then
        if git diff --cached --name-only | grep -q "backend/requirements.txt"; then
            echo "ğŸ” Validating backend requirements.txt format..."
            # Check for comments without space after # (e.g., #comment instead of # comment)
            if grep -E '#[^[:space:]]' backend/requirements.txt >/dev/null 2>&1; then
                echo "âŒ Malformed requirements.txt detected - comments must have space after #"
                echo "ğŸ”§ Fix by ensuring all comments have proper spacing: # comment"
                echo "ğŸ” Found:"
                grep -E '#[^[:space:]]' backend/requirements.txt
                exit 1
            fi
            echo "âœ… Backend requirements.txt format is valid"
        fi
    fi
    
    # =========================================================================
    # SMART TEST EXECUTION
    # =========================================================================
    # Skip tests for infrastructure-only changes (no code modified)
    CHANGED_FILES=$(git diff --cached --name-only)
    CODE_CHANGED=false

    # Check if any Python/JavaScript code was modified
    if echo "$CHANGED_FILES" | grep -qE '\.(py|js|vue|ts)$'; then
        CODE_CHANGED=true
    fi

    # Infrastructure-only changes that don't require tests
    if ! $CODE_CHANGED && echo "$CHANGED_FILES" | grep -qE '^(Dockerfile|.*\.yml|.*\.yaml|.*nginx\.conf|Makefile|\.github/)'; then
        echo "ğŸ“¦ Infrastructure-only changes detected - skipping tests"
    else
        echo "ğŸ§ª Running unit tests (required for commits)..."

        # Ensure backend dependencies are installed
        if [ ! -d "backend/venv" ] || [ ! -f "backend/venv/bin/pytest" ]; then
            echo "ğŸ”§ Installing backend dependencies (first time setup)..."
            cd backend
            python3 -m venv venv 2>/dev/null || true
            . venv/bin/activate
            pip install -q -r requirements.txt
            deactivate
            cd ..
        fi

        if make test >/dev/null 2>&1; then
            echo "âœ… All tests passed"
        else
            echo "âŒ Tests failed! Commit aborted."
            echo "ğŸ’¡ Run 'make test' locally to see detailed error output"
            echo "ğŸ’¡ Or use 'git commit --no-verify' to bypass (use with caution)"
            exit 1
        fi
    fi
else
    echo "ğŸ“‹ No changes staged for commit"
fi

echo "âœ… All quality checks passed - commit proceeding"